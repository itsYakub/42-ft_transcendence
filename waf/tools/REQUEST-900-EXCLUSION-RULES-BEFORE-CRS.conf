# REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf
#
# Targeted Google OAuth exclusions
# This rule matches both the initial redirect and the callback (with any query string)
# and removes specific ModSecurity checks that cause false positives.

SecRule REQUEST_URI "@rx ^/(auth/google|auth/google/callback|oauth2callback|api/auth/callback/google)(\?.*)?$" \
    "id:1000001, \
    phase:1, \
    pass, \
    nolog, \
    t:none, \
    ctl:ruleRemoveTargetById=930120;ARGS:scope, \
    ctl:ruleRemoveTargetById=930121;REQUEST_HEADERS:Referer, \
    ctl:ruleRemoveTargetById=931130;ARGS:scope, \
    ctl:ruleRemoveById=949110"

# Optional: Narrow exclusions for JWT-heavy POSTs on callback endpoints.
# Use this instead of the broader rule above if you prefer more precision.
# Uncomment this block and comment out the one above if needed.

#SecRule REQUEST_URI "@rx ^/(auth/google/callback|oauth2callback|api/auth/callback/google)(\?.*)?$" \
#    "id:1000002, \
#    phase:1, \
#    pass, \
#    nolog, \
#    t:none, \
#    ctl:ruleRemoveTargetById=941100;ARGS:state, \
#    ctl:ruleRemoveTargetById=942100;ARGS:state, \
#    ctl:ruleRemoveTargetById=941100;ARGS:code, \
#    ctl:ruleRemoveTargetById=942100;ARGS:code, \
#    ctl:ruleRemoveTargetById=941100;ARGS:credential, \
#    ctl:ruleRemoveTargetById=942100;ARGS:credential, \
#    ctl:ruleRemoveTargetById=941100;ARGS:id_token, \
#    ctl:ruleRemoveTargetById=942100;ARGS:id_token"
